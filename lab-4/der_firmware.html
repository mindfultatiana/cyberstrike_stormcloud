<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
      <link rel="shortcut icon" href="../img/favicon.ico" />
    <title>Investigating DER Firmware - CyberStrike Lab Workbook</title>
    <link rel="stylesheet" href="../css/theme.css" />
    <link rel="stylesheet" href="../css/theme_extra.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css" />
    
      <script>
        // Current page data
        var mkdocs_page_name = "Investigating DER Firmware";
        var mkdocs_page_input_path = "lab-4\\der_firmware.md";
        var mkdocs_page_url = null;
      </script>
    
    <!--[if lt IE 9]>
      <script src="../js/html5shiv.min.js"></script>
    <![endif]-->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
      <script>hljs.highlightAll();</script> 
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
          <a href="../index.html" class="icon icon-home"> CyberStrike Lab Workbook
        </a>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../index.html">Home</a>
                </li>
              </ul>
              <p class="caption"><span class="caption-text">Overview</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../overview/labs_over.html">Laboratory Background Info</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Lab 1 - Exploiting DER Interfaces</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../lab-2/over_lab2.html">Overview, Goals, Prerequisites</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" >Exercises</a>
    <ul>
                <li class="toctree-l2"><a class="reference internal" href="../lab-2/recon_nmap2.html">Reconnaissance with Nmap</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../lab-2/brute_force_ssh2.html">Brute Forcing SSH Passwords</a>
                </li>
    </ul>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Lab 2 - DOS Attacks</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../lab-3/over_lab4.html">Overview, Goals, Prerequisites</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" >Exercises</a>
    <ul>
                <li class="toctree-l2"><a class="reference internal" href="../lab-3/dos.html">Denial of Service (DOS)</a>
                </li>
    </ul>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Lab 3 - Firmware Analysis</span></p>
              <ul class="current">
                  <li class="toctree-l1"><a class="reference internal" href="over_lab3b.html">Overview, Goals, and Prerequisites</a>
                  </li>
                  <li class="toctree-l1 current"><a class="reference internal current" >Exercises</a>
    <ul class="current">
                <li class="toctree-l2 current"><a class="reference internal current" href="#">Investigating DER Firmware</a>
    <ul class="current">
    </ul>
                </li>
    </ul>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Lab 4 - Firmware Cryptography</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="over_lab3.html">Overview, Goals, and Prerequisites</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" >Exercises</a>
    <ul>
                <li class="toctree-l2"><a class="reference internal" href="malicious_update.html">Malicious Firmware</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="encrypt_decrypt_data3.html">Encrypting/Decrypting Data (optional)</a>
                </li>
    </ul>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Lab 5 - Web Exploitation</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../lab-5/over_lab5.html">Overview, Goals, Prerequisites</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" >Exercises</a>
    <ul>
                <li class="toctree-l2"><a class="reference internal" href="../lab-5/web_exploit.html">Website Exploits</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../lab-5/control_der_vnc5.html">Controlling the DER through VNC</a>
                </li>
    </ul>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Lab 6 - Vulnerable API and App Security</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../lab-6/over_lab6.html">Overview, Goals, Prerequisites</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" >Exercises</a>
    <ul>
                <li class="toctree-l2"><a class="reference internal" href="../lab-6/interacting_api.html">Vulnerable API</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../lab-6/app_inspect.html">Smart Phone App Inspection</a>
                </li>
    </ul>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Lab 7 - Replay and MITM Attacks</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../lab-7/over_lab7.html">Overview, Goals, Prerequisites</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" >Exercises</a>
    <ul>
                <li class="toctree-l2"><a class="reference internal" href="../lab-7/replay-mitm.html">Replay and MITM</a>
                </li>
    </ul>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Lab 8 - Security Improvements</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../lab-8/over_lab8.html">Overview, Goals, Prerequisites</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" >Exercises</a>
    <ul>
                <li class="toctree-l2"><a class="reference internal" href="../lab-8/20305firewalls.html">IEEE 2030.5 and FWs</a>
                </li>
    </ul>
                  </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../about.html">About</a>
                </li>
              </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
      <nav class="wy-nav-top" role="navigation" aria-label="Mobile navigation menu">
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">CyberStrike Lab Workbook</a>
        
      </nav>
      <div class="wy-nav-content">
        <div class="rst-content"><div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../index.html" class="icon icon-home" aria-label="Docs"></a></li>
          <li class="breadcrumb-item">Lab 3 - Firmware Analysis</li>
          <li class="breadcrumb-item">Exercises</li>
      <li class="breadcrumb-item active">Investigating DER Firmware</li>
    <li class="wy-breadcrumbs-aside">
    </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
            <div class="section" itemprop="articleBody">
              
                <h2 id="investigating_der_firmware">Investigating DER Firmware<a class="headerlink" href="#investigating_der_firmware" title="Permanent link">&para;</a></h2>
<ol>
<li>
<p>Navigate to the firmware directory.</p>
<p><code>cd ~/firmware-images</code></p>
<p>Show the directory contents:</p>
<p><code>ls</code></p>
<p>In this directory there are several software and firmware files for PV inverters and other devices. You can download these files from the vendor (typically) directly from their website. As an example, here is the firmware location for SolarEdge: <a href="https://www.solaredge.com/us/service/firmware">SolarEdge</a>.</p>
</li>
<li>
<p>Let’s see if the data is encrypted by dumping the first 20 lines of the file to the 
screen using the ‘head’ command.</p>
<p><code>cd Solar_SolarEdge</code></p>
<p><code>ls</code></p>
<p><code>head -n 20 CPU_3_2537_3_2618.bsuf</code></p>
<p><img alt="Firmware Dump" src="../img/lab3-firmware-dump.png" /></p>
</li>
<li>
<p>Clearly this file is human-readable and not encrypted. What sort of information can we learn about the product from the firmware image? Let’s look at printable strings in file with a length of 20 characters or more:</p>
<p><code>strings -n 20 CPU_3_2537_3_2618.bsuf</code></p>
<p>Scroll through the data to identify some interesting power parameters and strings associated with “Modbus”, “Wireless”, “Portia3” (the name of their Linux distribution), etc.</p>
<p><img alt="" src="../img/Portia.PNG" /></p>
</li>
<li>
<p>Let’s find if there are any hard-coded websites using grep to match certain characters 
in the output:   </p>
<p><code>strings -n 20 CPU_3_2537_3_2618.bsuf | grep "\.com"</code></p>
</li>
<li>
<p>Let’s find if this device uses Modbus, RS-485 serial communications, wireless, etc.   </p>
<p><code>strings -n 8 CPU_3_2537_3_2618.bsuf | grep -i "wireless"</code></p>
<p><code>strings -n 8 CPU_3_2537_3_2618.bsuf | grep -i "RS485"</code></p>
<p><code>strings -n 8 CPU_3_2537_3_2618.bsuf | grep -i "sunspec"</code></p>
<p><img alt="Modbus 485" src="../img/strings-modbus-485.png" /></p>
</li>
<li>
<p>Searching for the firmware extension may give hints to where it is stored on the device and the mechanics of the updated.</p>
<p><code>strings -n 8 CPU_3_2537_3_2618.bsuf | grep -i "bsuf"</code></p>
</li>
<li>
<p>Let’s see if there’s anything about the EV Chargers in this firmware update.   </p>
<p><code>strings -n 8 CPU_3_2537_3_2618.bsuf | grep -i "Charger"</code></p>
<p><code>strings -n 8 CPU_3_2537_3_2618.bsuf | grep -i "EVSE"</code></p>
<p><img alt="Strings EV Chargers" src="../img/lab3-strings-ev-chargers.png" /></p>
</li>
<li>
<p>Think about what an adversary could do with this information. Is it possible to modify this firmware to make the equipment not work, change the hard-coded websites, or modify the scaling on the power parameters? It is likely that this would be difficult because there are Cyclic redundancy check (CRC) codes and/or hashes that would need to be aligned with the firmware changes.  These are often located at the end of the file. Let's print the last 5 lines of the firmware. </p>
<p><code>tail -n 5 CPU_3_2537_3_2618.bsuf</code></p>
<p><img alt="Firmware Dump 2" src="../img/lab3-firmware-dump.png" /></p>
<p>It is possible there is a CRC code there, but it is difficult to know.  It's not obvious from the hex data either. </p>
<p><code>tail -n 5 CPU_3_2537_3_2618.bsuf | hexdump -C</code></p>
</li>
</ol>
<h2 id="investigating_solar_firmware">Investigating Solar Firmware<a class="headerlink" href="#investigating_solar_firmware" title="Permanent link">&para;</a></h2>
<ol>
<li>
<p>Navigate to the <strong>Fronius</strong> firmware directory using the filesystem browser in the Kali VM:</p>
<p><code>cd ~/firmware-images/Solar_Fronius/</code></p>
<p><code>head fro32070.upd</code></p>
</li>
<li>
<p>Let’s look around for human-readable content.</p>
<p><code>strings -n 10 fro32070.upd</code></p>
<p>Now look to see what versions of the Symo product exist in this firmware image:</p>
<p><code>strings fro32070.upd | grep Symo</code></p>
<p>Is there any reference to the California Electric Rule 21 grid code?</p>
<p><code>strings fro32070.upd | grep Rule21</code></p>
<p>These are likely the different modes of operation for this firmware with different voltage levels, with and without a neutral connection. </p>
</li>
<li>
<p>Not all firmware is human-readable. Some companies will compress, encrypt, or otherwise obfuscate their firmware images to reduce the ability of an adversary to modify the software. For instance, let's look at the <strong>SMA</strong> firmware. There’s little that is human-readable except the version number.</p>
<p><code>strings -n 10 ../Solar_SMA/SB5.5-LV-JP-41-1.02.06.R.up2 | less</code></p>
<p>(Use <code>space</code> to scroll through the content and <code>q</code> to exit)</p>
</li>
<li>
<p>We can look at the binary data and see that it’s mostly gibberish. </p>
<p><code>hexdump -C ../Solar_SMA/*.up2 | head -n 50</code></p>
<p>To confirm, we can perform an entropy analysis on the data:</p>
<p><code>binwalk -E ../Solar_SMA/*.up2</code></p>
<p>The entropy will be high (close to 1) when the bytes in the image look random, and that could mean the image has an encrypted, compressed, or otherwise obfuscated file.</p>
<p><img alt="" src="../img/SMA_Entropy.PNG" />
(Close the image with the <code>x</code> in the upper right after inspecting it.)</p>
</li>
<li>
<p>Compare that to the Fronius data with portions of human readable data (entropy is less than 1 for large portions of the file).</p>
<p><code>binwalk -E ../Solar_Fronius/fro32070.upd</code></p>
<p><img alt="" src="../img/Fronius_Entropy.PNG" />
(Close the image with the <code>x</code> in the upper right after inspecting it.)</p>
</li>
<li>
<p>Look at the <strong>Schneider Electric XW+</strong> firmware. There is nothing human-readable but there are portions of the data that have lower entropy, indicating the file is not encrypted. Instead it may be compressed in some way.</p>
<p><code>cd ~/firmware-images/Solar_Schneider/conext-xw-6848-120240v-firmware-version-2-07-bn-4/Conext\ XW+\ 6848\ 120-240V/</code></p>
<p><code>head 865-6848-01.02_07_00.BN0004.xf0</code></p>
<p><code>strings -n 10 865-6848-01.02_07_00.BN0004.xf0</code></p>
<p><code>binwalk -E 865-6848-01.02_07_00.BN0004.xf0</code></p>
<p><img alt="" src="../img/Schneider_Entropy.PNG" /></p>
</li>
</ol>
<h2 id="lessons_learned">Lessons Learned<a class="headerlink" href="#lessons_learned" title="Permanent link">&para;</a></h2>
<p>Open-source tools are available to open, examine, and pull relevant information out of a variety of firmware files. Using these tools, an adversary can better understand the environment in which they are interacting, and potentially manipulate firmware to impact the devices.</p>
<p>Operators can use the techniques from this lab to investigate if firmware is encrypted or contains human-readable content that could expose operating system, programs, open ports/services, authors, software programs used on the devices, and more. </p>
<p>DER vendors should consider encrypting their firmware images to minimize the likelihood of adversaries gaining more information about their operating environment. </p>
              
            </div>
          </div><footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="Footer Navigation">
        <a href="over_lab3b.html" class="btn btn-neutral float-left" title="Overview, Goals, and Prerequisites"><span class="icon icon-circle-arrow-left"></span> Previous</a>
        <a href="over_lab3.html" class="btn btn-neutral float-right" title="Overview, Goals, and Prerequisites">Next <span class="icon icon-circle-arrow-right"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
      <p>2022 National Technology and Engineering Solutions of Sandia, LLC</p>
  </div>

  Built with <a href="https://www.mkdocs.org/">MkDocs</a> using a <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
          
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="Versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
    
      <span><a href="over_lab3b.html" style="color: #fcfcfc">&laquo; Previous</a></span>
    
    
      <span><a href="over_lab3.html" style="color: #fcfcfc">Next &raquo;</a></span>
    
  </span>
</div>
    <script src="../js/jquery-3.6.0.min.js"></script>
    <script>var base_url = "..";</script>
    <script src="../js/theme_extra.js"></script>
    <script src="../js/theme.js"></script>
    <script>
        jQuery(function () {
            SphinxRtdTheme.Navigation.enable(true);
        });
    </script>

</body>
</html>
